# 5.7
今天只是初步的搞了一个超级简单的框架，也不知道之后是不是就按照这个流程搞了，或者有可能根本就用不了。

脚手架还是非常重要的，先搭起来吧。如果未来失败了，再反思成长好了。

# 5.8
really really 不想干活，注意力被四处吸引。我重新思考了一下，可能暂时不需要 ParamLoader 这个类。

功能先放在 Layer 好了，创建 ParamLoader 是想要职责分离，但是对 parameter 进行操作还要设计 device 分配之类乱七八糟的东西。

先统一到 Layer 里，之后再重构好了。重新思考了下架构，**layer 和 communicator 之间的关系理清了**，这是一个重大突破。

思考了一下，这种严格先搭架子后填肉的工作方式，不太适合现在的我。因为我没有实现经验，搭架子就很耗费时间，想办法做验证也是十分不合算。

所以我打算在有整体的构思下，边搭架子，边填肉。整体构思如下：

* 推理引擎主体（Engine）：
    * 初始化和资源分配
    * Engine 将需要处理的数据通过 Scheduler 分发给 Worker

* 任务调度模块（Scheduler）
    * 接收Engine提交的推理任务，维护任务队列

* 具体推执行单元（Worker）
    * 接收来自 Scheduler 的任务
    * 调用 Layer 进行模型的前向推理运算
    * 设备计算上下文控制能力


* 设备管理模块（Device Manager）
* 计算设备抽象（Device）
    * 使用 Allocator 管理内存
    * 将计算任务通过 Function 执行，实际执行 Device 上的计算核函数
    
* 模型层次模块（Layer）
    * Layer 不直接使用 Communicator，而是暴露接口或声明自己的通信需求。

* 通信管理模块（Communicator）
    * 执行跨设备的数据通信操作（AllReduce等）
    * 管理通信上下文与句柄

* 模型加载与配置模块（Model Loader）

# 5.9
不想干活不想干活不想干活不想干活

吸 ~ 呼 ~ 冷静，今天先把 Device 类设计好，**设备种类**在 Device 处做好多态，**数据格式**在 Function 处做多态。

Function 函数这里有个问题就是，KV Cache 最好做成分页式的，这样就不用一次全部分页了。*我需要调研一下这个机制是怎么实现的*

调研这件事先留在明天吧，一次干太多事容易把心态搞崩。刚刚突然有个想法，**可以把decoder层整个融合到一个函数里，或者把attention和ffn前面的norm融合到一起，测一测效果。**

下午被抓去干活了，这边已经不记得干到哪里了。。。等明天来整理思路吧......